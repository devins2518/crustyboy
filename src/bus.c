#include "bus.h"
#include "utils.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

const uint8_t BOOTROM_DEFAULT[BOOTROM_SIZE] = {
    0x31, 0xFE, 0xFF, 0xAF, 0x21, 0xFF, 0x9F, 0x32, 0xCB, 0x7C, 0x20, 0xFB,
    0x21, 0x26, 0xFF, 0x0E, 0x11, 0x3E, 0x80, 0x32, 0xE2, 0x0C, 0x3E, 0xF3,
    0xE2, 0x32, 0x3E, 0x77, 0x77, 0x3E, 0xFC, 0xE0, 0x47, 0x11, 0x04, 0x01,
    0x21, 0x10, 0x80, 0x1A, 0xCD, 0x95, 0x00, 0xCD, 0x96, 0x00, 0x13, 0x7B,
    0xFE, 0x34, 0x20, 0xF3, 0x11, 0xD8, 0x00, 0x06, 0x08, 0x1A, 0x13, 0x22,
    0x23, 0x05, 0x20, 0xF9, 0x3E, 0x19, 0xEA, 0x10, 0x99, 0x21, 0x2F, 0x99,
    0x0E, 0x0C, 0x3D, 0x28, 0x08, 0x32, 0x0D, 0x20, 0xF9, 0x2E, 0x0F, 0x18,
    0xF3, 0x67, 0x3E, 0x64, 0x57, 0xE0, 0x42, 0x3E, 0x91, 0xE0, 0x40, 0x04,
    0x1E, 0x02, 0x0E, 0x0C, 0xF0, 0x44, 0xFE, 0x90, 0x20, 0xFA, 0x0D, 0x20,
    0xF7, 0x1D, 0x20, 0xF2, 0x0E, 0x13, 0x24, 0x7C, 0x1E, 0x83, 0xFE, 0x62,
    0x28, 0x06, 0x1E, 0xC1, 0xFE, 0x64, 0x20, 0x06, 0x7B, 0xE2, 0x0C, 0x3E,
    0x87, 0xE2, 0xF0, 0x42, 0x90, 0xE0, 0x42, 0x15, 0x20, 0xD2, 0x05, 0x20,
    0x4F, 0x16, 0x20, 0x18, 0xCB, 0x4F, 0x06, 0x04, 0xC5, 0xCB, 0x11, 0x17,
    0xC1, 0xCB, 0x11, 0x17, 0x05, 0x20, 0xF5, 0x22, 0x23, 0x22, 0x23, 0xC9,
    0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B, 0x03, 0x73, 0x00, 0x83,
    0x00, 0x0C, 0x00, 0x0D, 0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
    0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99, 0xBB, 0xBB, 0x67, 0x63,
    0x6E, 0x0E, 0xEC, 0xCC, 0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E,
    0x3C, 0x42, 0xB9, 0xA5, 0xB9, 0xA5, 0x42, 0x3C, 0x21, 0x04, 0x01, 0x11,
    0xA8, 0x00, 0x1A, 0x13, 0xBE, 0x20, 0xFE, 0x23, 0x7D, 0xFE, 0x34, 0x20,
    0xF5, 0x06, 0x19, 0x78, 0x86, 0x23, 0x05, 0x20, 0xFB, 0x86, 0x20, 0xFE,
    0x3E, 0x01, 0xE0, 0x50,
};

bus bus_new(cartridge_t cart) {
    bus b;
    memcpy(b.bootrom, BOOTROM_DEFAULT, BOOTROM_SIZE);
    memset(b.vram, 0, VRAM_SIZE);
    memset(b.ram, 0, RAM_SIZE);
    memset(b.sat, 0, SAT_SIZE);
    memset(b.io, 0, IO_SIZE);
    memset(b.hram, 0, HRAM_SIZE);
    b.ie_reg = 0;
    b._finished_boot = FALSE;
    b.cart = cart;
    return b;
}

uint8_t get_address(bus *self, uint16_t addr) {
    uint8_t val;
    val = 0x00;
    if (addr >= 0x0000 && addr <= 0x100) {
        if (!self->_finished_boot) {
            val = self->bootrom[addr];
            if (addr == BOOTROM_SIZE)
                self->_finished_boot = TRUE;
        } else
            val = get_cartridge_addr(&self->cart, addr);
    } else if (addr >= 0x0101 && addr <= 0x7FFF)
        val = get_cartridge_addr(&self->cart, addr);
    else if (addr >= 0x8000 && addr <= 0x9FFF)
        val = self->vram[addr % VRAM_START];
    else if (addr >= 0xA000 && addr <= 0xBFFF)
        val = get_cartridge_addr(&self->cart, addr);
    else if (addr >= 0xC000 && addr <= 0xDFFF)
        val = self->ram[addr % RAM_START];
    else if (addr >= 0xE000 && addr <= 0xFDFF)
        val = self->ram[(addr - 0x2000) % RAM_START];
    else if (addr >= 0xFE00 && addr <= 0xFE9F)
        val = self->sat[addr % SAT_START];
    else if (addr >= 0xFEA0 && addr <= 0xFEFF)
        return 0x00;
    else if (addr >= 0xFF00 && addr <= 0xFF7F)
        val = self->io[addr % IO_START];
    else if (addr >= 0xFF80 && addr <= 0xFFFE)
        val = self->hram[addr % HRAM_START];
    else if (addr >= 0xFFFF)
        val = self->ie_reg;

    return val;
}

void write_address(bus *self, uint16_t addr, uint8_t n) {
    if (0x0000 <= addr && addr <= 0x100) {
        if (!self->_finished_boot)
            self->bootrom[addr] = n;
        else
            PANIC("cart op boot");
        /* self->cart.getAddr(addr).* = n; */
    } else if (0x0101 <= addr && addr <= 0x7FFF)
        PANIC("cart op outside boot")
    /* self->cart.getAddr(addr).* = n; */
    else if (0x8000 <= addr && addr <= 0x9FFF)
        self->vram[addr % VRAM_START] = n;
    else if (0xA000 <= addr && addr <= 0xBFFF)
        PANIC("attempted to write from cartridge")
    else if (0xC000 <= addr && addr <= 0xDFFF)
        self->ram[addr % RAM_START] = n;
    else if (0xE000 <= addr && addr <= 0xFDFF)
        self->ram[(addr - 0x2000) % RAM_START] = n;
    else if (0xFE00 <= addr && addr <= 0xFE9F)
        self->sat[addr % SAT_START] = n;
    else if (0xFEA0 <= addr && addr <= 0xFEFF)
        PANIC("unhandled")
    else if (0xFF00 <= addr && addr <= 0xFF7F)
        self->io[addr % IO_START] = n;
    else if (0xFF80 <= addr && addr <= 0xFFFE)
        self->hram[addr % HRAM_START] = n;
    else
        self->ie_reg = n;
}

void bus_free(bus self) { cartridge_free(self.cart); }
