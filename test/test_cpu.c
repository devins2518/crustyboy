#include "src/gamegirl.h"
#include <assert.h>

/* clang-format off */
const uint8_t TEST_BOOTROM[256] = {
    0x00, /* NOOP 1m */
    0x01, 0xFE, 0xCA, /* LD BC, u16 3m */
    0x02, /* LD (BC), A 2m */
    0x03, /* INC BC 2m */
    0x04, /* INC B 1m */
    0x05, /* DEC B 1m */
    0x06, 0xAA, /* LD B, u8 2m */
    0x08, 0xFE, 0xCA, /* LD {u16}, SP 5m */
    0x09, /* ADD HL, BC 2m */
    0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
/* clang-format on */

int main() {
    gamegirl *gg = gamegirl_init(NULL);
    memcpy(gg->bus.bootrom, TEST_BOOTROM, 256);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 1);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 4);
    assert(gg->cpu.bc.u8.b == 0xCA);
    assert(gg->cpu.bc.u8.c == 0xFE);
    assert(gg->cpu.bc.u16 == 0xCAFE);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 6);
    assert(bus_read(&gg->bus, gg->cpu.bc.u16) == gg->cpu.af.u8.a);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 8);
    assert(gg->cpu.bc.u16 == 0xCAFF);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 9);
    assert(gg->cpu.bc.u8.b == 0xCB);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 10);
    assert(gg->cpu.bc.u8.b == 0xCA);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 12);
    assert(gg->cpu.bc.u8.b == 0xAA);
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 17);
    assert(bus_read(&gg->bus, 0xCAFE) == (gg->cpu.sp & 0xFF));
    assert(bus_read(&gg->bus, 0xCAFE + 1) == ((gg->cpu.sp >> 8) & 0xFF));
    cpu_clock(&gg->cpu);
    assert(gg->cpu.clocks == 19);
    assert(gg->cpu.hl.u16 == 0xAAFF);
}
